---
title: 我用 AI + GT 做了一个全自动自动打卡机
date: 2022-10-31 00:41:17
categories: 
- 深度学习
tags:
- AI
- 人脸识别
- 人脸匹配
- 自动考勤
---

## 0x00 前言

自从搬来天空之城后，因为打卡习惯改变了，导致我上下班经常忘记打卡。

于是我就有了一个构想：能不能在工位做一个打卡机，到点就帮我自动打卡呢？


## 0x10 合规自检

首先这个事情得先确保合规性，公司目前允许打卡的方式有 2 个：

1. 各楼层门禁
2. 手机 GT （只能在公司范围内）

很自然的就想到只能用手机 GT 来做了，而且因为是在工位打卡，应该是没有问题的。

------

另外早两年做过手机 GT 的渗透，知道 GT 本身也有一些限制条件：

1. 禁止在 ROOT 手机上启动
2. 禁止在模拟器启动
3. 禁止第三方 APP 拉起 GT 服务
4. 必须是本人在摄像头前面才能打卡

所以现在的问题在于，**怎么在前面所有约束条件下，实现自动化打卡呢？**


## 0x20 思路 

### 0x21 版本一

最简单粗暴直接的方法，就是用一个支架把手机立起来，并且打开 GT 签到的界面，然后写一个后台程序定时模拟点击打卡按钮。

但是这个方法不可取，因为 APP 默认是无权限解锁手机屏幕的（起码非 ROOT 环境不行），换言之这个方案成立的必要条件是手机一直亮屏，从安全性考虑就已经不会采纳了。

![](01.jpg)


### 0x22 版本二

由于我的工作手机是 Android 的，所以我在呼吸时就想到借助 [ADB (Android Debug Bridge)](https://developer.android.com/studio/command-line/adb) 工具了。

因此思路转变为：

1. PC 通过 ADB 连接手机
2. PC 设置【上/下班打卡】两个定时任务脚本，脚本触发时：
    - 通过 ADB 指令解除手机的锁屏状态
    - 通过 ADB 指令模拟人工操作，启动 GT 并打卡
    - 通过 ADB 指令通知手机锁屏

硬件接线参考下图：

> 由于需要 ADB 通讯和长时间待机，因此手机支架我采购了可充电式的

![](02.jpg)

但是这个方法纯粹只是通过定时任务触发的，若触发时我不在工位上，手机被解锁，依然会有安全风险。

所以这里还欠缺一个关键条件：**必须是【我】在工位上才能解锁手机！**


### 0x23 最终方案

由于我不久前才做过一期视觉 AI，于是我又很自然地在喝水时想到了：**利用 PC 的摄像头做人脸识别**不就可以了吗？

最终整个方案设计演变成这样：

![](03.png)

> 由于只需要识别【我】一个人，所以人脸识别服务完全可以部署在 PC 本地



## 0x30 关键实现

### 0x31 人脸识别

这里不深入展开人脸识别的原理，只是简单描述一下过程（后面有时间再考虑做一个专题）：

![](04.png)

图是网上找的，这里解释稍微一下，人脸识别用到的技术一般离不开以下四点：

- 人脸检测（Face Detection）: 这步推荐用开源工具实现，如 MediaPipe、OpenPose、MMPose、dlib、opencv 等都可以实现
- 人脸对齐（Face Alignment）: 基于检测得到关键点地标，进行归一化和仿射变换（平移/旋转/缩放），目的是把人脸尽可能映射到同一参考系中，提高后续计算的精度
- 人脸编码（Face Encodings）: 把关键点地标输入神经网络，得到人脸特征值（计算方法目前一般是闭源的），常用的特征值有 128 维，可以代表一张脸
- 人脸比对（Face Compare）: 通过计算两个特征值的 欧式距离/余弦距离，得到人脸相似度，即克判断是否为同一人  

> 这里不涉及活体检测

------

因此，基于前面的方案设计和技术原理，提前计算【我】本人的面部特征值、并写如特征库，是必要的准备工作。

而且录入特征时，需要把我的正脸和侧脸一起录进去。

这是因为我的 PC 摄像头是斜对着我的，我这个 AI 又比较简单，没学过怎么从侧脸推理出正脸，所以为了提高成功率，需要把两种角度的面部特征都存到特征库。

![](06.jpg)

因为在工位的时候，我很少戴口罩，所以只取了五官的地标去计算特征值。

如果要戴口罩也能准确识别出来的话，最多可以识别出 468 个地标，取上半脸的地标计算特征值：

![](07.jpg)


有了特征值，往后的事情就比较简单了：

- 每当到达打卡时间点时，激活 PC 摄像头、并采集最接近画面的人脸
- 如果该人脸的特征值，与特征库中【我】的特征值相似度较高，则用 ADB 解锁手机 GT 打卡
- 否则取消该轮打卡动作


## 0x32 ADB

[ADB (Android Debug Bridge)](https://developer.android.com/studio/command-line/adb) 是 Android 调试的常用工具之一。

在这里主要是用 ADB 模拟手动操作，所以不需要 ROOT 手机。

要实现模拟 GT 打卡，只需要组合 6 个 ADB 命令：

- 唤醒屏幕: `adb shell input keyevent 224`
- 滑动屏幕: `adb shell input swipe <x1> <y1> <x2> <y2>`
- 输入锁屏密码: `adb shell input text <password>`
- 返回首页: `adb shell input keyevent 3`
- 点击屏幕某个坐标: `adb shell input tap <x> <y>`
- 锁屏: `adb shell input keyevent 223`

根据实际手机的屏幕分辨率修改命令坐标，即可实现在任意 Android 中模拟手动在 GT 打卡的流程。


## 0x40 成品展示

1. 演示特征录入
2. 演示自动打卡（PC + 手机两个屏幕）


## 0x50 参考文档

- 《[MediaPipe Face Detection](https://google.github.io/mediapipe/solutions/face_detection.html)》
- 《[欧氏距离和余弦相似度](https://cloud.tencent.com/developer/article/1487432)》
- 《[正则化的 L2 范数](https://blog.csdn.net/u010725283/article/details/79212762)》

